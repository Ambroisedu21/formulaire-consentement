<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Formulaire RGPD HubSpot</title>
  <style>
    body { font-family: sans-serif; padding: 2rem; }
    .hidden { display: none; }
    #cookie-banner { background: #f0f0f0; padding: 1rem; margin-bottom: 2rem; border: 1px solid #ccc; }
    label { display: block; margin-top: 1rem; }
    input[type="text"], input[type="email"] { width: 300px; padding: 0.5rem; }
  </style>
</head>
<body>

  <h1>Formulaire de contact</h1>

  <div id="cookie-banner">
    Ce site utilise des cookies. Acceptez-vous leur utilisation ?
    <button onclick="acceptCookies()">Accepter</button>
    <button onclick="declineCookies()">Refuser</button>
  </div>

  <form id="contact-form" class="hidden">
    <label>Prénom :
      <input type="text" name="firstname" required>
    </label>
    <label>Nom :
      <input type="text" name="lastname" required>
    </label>
    <label>Email :
      <input type="email" name="email" required>
    </label>

    <p>
      <input type="checkbox" id="consent" required>
      En cliquant sur envoyer ci-dessous vous autorisez l'entreprise Ambroise Training à stocker et traiter les données personnelles soumises ci-dessus qu'elle vous fournisse le contenu demandé.
    </p>

    <button type="submit">Envoyer</button>
  </form>

  <div id="response-message"></div>

  <script>
    const form = document.getElementById('contact-form');
    const message = document.getElementById('response-message');

    // Gestion consentement
    const accepted = localStorage.getItem('cookiesAccepted');

    if (accepted === 'true') {
      loadHubSpot();
      form.classList.remove('hidden');
      document.getElementById('cookie-banner').style.display = 'none';
    } else if (accepted === 'false') {
      form.classList.remove('hidden'); // on peut envoyer sans tracking
      document.getElementById('cookie-banner').style.display = 'none';
    }

    function acceptCookies() {
      localStorage.setItem('cookiesAccepted', 'true');
      loadHubSpot();
      document.getElementById('cookie-banner').style.display = 'none';
      form.classList.remove('hidden');
    }

    function declineCookies() {
      localStorage.setItem('cookiesAccepted', 'false');
      document.getElementById('cookie-banner').style.display = 'none';
      form.classList.remove('hidden');
    }

    function loadHubSpot() {
      const script = document.createElement('script');
      script.src = 'https://js.hs-scripts.com/49153213.js'; // remplace avec ton portal ID
      script.async = true;
      script.type = 'text/javascript';
      script.onload = () => console.log('HubSpot script chargé');
      document.body.appendChild(script);
    }

    // Soumission du formulaire via API
    form.addEventListener('submit', async function (e) {
      e.preventDefault();

      const data = {
        fields: [
          { name: "firstname", value: form.firstname.value },
          { name: "lastname", value: form.lastname.value },
          { name: "email", value: form.email.value }
        ],
        context: {
          pageUri: window.location.href,
          pageName: document.title,
          hutk: localStorage.getItem('cookiesAccepted') === 'true' ? getCookie("hubspotutk") : null
        }
      };

      try {
        const response = await fetch("https://api.hsforms.com/submissions/v3/integration/submit/49153213/1e7f2630-56a1-48a1-a4e6-eced1e4ffb83", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        });

        if (response.ok) {
          message.innerHTML = "<p>✅ Formulaire envoyé avec succès !</p>";
          form.reset();
        } else {
          message.innerHTML = "<p>❌ Une erreur est survenue.</p>";
        }
      } catch (err) {
        message.innerHTML = `<p>❌ Erreur technique : ${err.message}</p>`;
      }
    });

    function getCookie(name) {
      const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
      return match ? match[2] : null;
    }
  </script>

</body>
</html>
