<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Formulaire RGPD compliant</title>
</head>
<body>
  <h1>Formulaire de contact</h1>
  <form id="contact-form">
    <label for="prenom">Prénom :</label>
    <input type="text" id="prenom" name="prenom" required><br><br>

    <label for="nom">Nom :</label>
    <input type="text" id="nom" name="nom" required><br><br>

    <label for="email">Email :</label>
    <input type="email" id="email" name="email" required><br><br>

    <label>
      <input type="checkbox" id="consentement" required>
      En cliquant sur envoyer ci-dessous vous autorisez l'entreprise Ambroise Training à stocker et traiter les données personnelles soumises ci-dessus qu'elle vous fournisse le contenu demandé.
    </label><br><br>

    <button type="submit">Envoyer</button>
  </form>

  <!-- Bannière de consentement -->
  <div id="consent-banner" style="position: fixed; bottom: 0; background: #eee; width: 100%; padding: 10px;">
    Acceptez-vous les cookies ?
    <button onclick="acceptCookies()">Accepter</button>
    <button onclick="refuseCookies()">Refuser</button>
  </div>

  <script>
    let hasConsent = false;

    function acceptCookies() {
      hasConsent = true;
      document.getElementById('consent-banner').style.display = 'none';

      // Injection du script HubSpot APRES consentement explicite
      const hsScript = document.createElement('script');
      hsScript.src = 'https://js.hs-scripts.com/49153213.js';
      hsScript.type = 'text/javascript';
      hsScript.async = true;
      document.head.appendChild(hsScript);
    }

    function refuseCookies() {
      hasConsent = false;
      document.getElementById('consent-banner').style.display = 'none';
      // AUCUNE ACTION, cookies non injectés
    }

    document.getElementById('contact-form').addEventListener('submit', async function (e) {
      e.preventDefault();

      const prenom = document.getElementById('prenom').value;
      const nom = document.getElementById('nom').value;
      const email = document.getElementById('email').value;

      // Préparation des données
      const payload = {
        fields: [
          { name: 'firstname', value: prenom },
          { name: 'lastname', value: nom },
          { name: 'email', value: email },
          { name: 'source_formulaire__c', value: 'Formulaire' }
        ],
        context: {
          pageUri: window.location.href,
          pageName: document.title
        }
      };

      // Envoi via API (sans cookie tracking)
      try {
        const response = await fetch('https://api.hsforms.com/submissions/v3/integration/submit/49153213/1262a4d1-1496-4553-b70d-64bcle676047', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (response.ok) {
          alert("Merci, vos données ont bien été transmises.");
          document.getElementById("contact-form").reset();
        } else {
          alert("Erreur lors de l'envoi. Veuillez réessayer.");
        }
      } catch (err) {
        alert("Erreur réseau : " + err.message);
      }
    });
  </script>
</body>
</html>
