<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Formulaire de contact RGPD</title>
  <!-- Google Tag Manager -->
  <script>
    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(), event:'gtm.js'});
    var f=d.getElementsByTagName(s)[0], j=d.createElement(s), dl=l!='dataLayer'?'&l='+l:'';
    j.async=true; j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;
    f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-55BBX5K4');
  </script>
  <!-- End Google Tag Manager -->

  <!-- Axeptio SDK -->
  <script>
    window.axeptioSettings = {
      clientId: "6880d227f0b041d2ff94a814",
      cookiesVersion: "ambroisedu21/formulaire-consentement/indexaxeptio-fr-EU"
    };
    (function(d, s) {
      var t = d.getElementsByTagName(s)[0], e = d.createElement(s);
      e.async = true; e.src = "https://static.axept.io/sdk.js";
      t.parentNode.insertBefore(e, t);
    })(document, "script");
  </script>

  <style>
    body { font-family: sans-serif; margin: 2em; }
    label { display: block; margin: 0.5em 0; }
    input, button { padding: 0.4em; }
    #message { margin-top: 1em; font-weight: bold; }
  </style>
</head>

<body>
  <!-- Google Tag Manager (noscript) -->
  <noscript>
    <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-55BBX5K4" height="0" width="0" style="display:none;visibility:hidden"></iframe>
  </noscript>
  <!-- End Google Tag Manager (noscript) -->

  <h1>Formulaire de contact</h1>
  <form id="contactForm">
    <label>Prénom : <input type="text" name="firstname" required></label>
    <label>Nom : <input type="text" name="lastname" required></label>
    <label>Email : <input type="email" name="email" required></label>
    <button type="submit">Envoyer</button>
  </form>
  <div id="message"></div>

  <script>
    const portalId = "49153213";
    const formId = "1262a4d1-1496-4553-b70d-64bc1e676047";

    document.getElementById("contactForm").addEventListener("submit", async function(e) {
      e.preventDefault();

      const form = e.target;
      const data = {
        fields: [
          { name: "firstname", value: form.firstname.value },
          { name: "lastname", value: form.lastname.value },
          { name: "email", value: form.email.value }
        ],
        context: {}
      };

      // Attendre qu'Axeptio soit prêt
      const waitForAxeptio = () => new Promise(resolve => {
        if (window._axeptioSDK) return resolve(window._axeptioSDK);
        const check = setInterval(() => {
          if (window._axeptioSDK) {
            clearInterval(check);
            resolve(window._axeptioSDK);
          }
        }, 100);
      });

      const axeptio = await waitForAxeptio();
      const hasConsent = axeptio.userHasConsentedTo("hubspot");

      // Ajouter tracking HubSpot uniquement si consentement
      if (hasConsent && window._hsq) {
        window._hsq.push(["trackPageView"]);
        data.context = {
          hutk: document.cookie.match(/hubspotutk=([\w\-]+)/)?.[1] || "",
          pageUri: window.location.href,
          pageName: document.title
        };
      }

      // Soumettre à HubSpot via API
      const response = await fetch(`https://api.hsforms.com/submissions/v3/integration/submit/${portalId}/${formId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });

      if (response.ok) {
        document.getElementById("message").innerText = "Merci, votre message a bien été envoyé.";
        form.reset();
      } else {
        document.getElementById("message").innerText = "Erreur lors de l'envoi du formulaire.";
        console.error(await response.text());
      }
    });
  </script>
</body>
</html>
